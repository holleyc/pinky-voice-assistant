<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pinky Openchat Chat</title>
  <style>
    body {
      font-family: monospace;
      background-color: #1e1e1e;
      color: #f0f0f0;
      margin: 0;
      padding: 1rem;
      line-height: 1.6;
    }
    h2 {
      color: #ff4d4d;
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    #status, #ollama-status {
      text-align: center;
      font-size: 1rem;
      color: #999;
      margin-bottom: 1rem;
    }
    #ollama-status {
      font-size: 0.9rem;
      font-style: italic;
    }
    #chat-box {
      border: 1px solid #444;
      background: #2a2a2a;
      padding: 1rem;
      height: 60vh;
      overflow-y: auto;
      border-radius: 8px;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    .message {
      margin-bottom: 1rem;
      word-wrap: break-word;
    }
    .user { color: #ff4d4d; font-weight: bold; }
    .ai   { color: #50fa7b; font-weight: bold; }
    .input-container {
      display: flex;
      gap: 0.5rem;
      width: 100%;
      margin-bottom: 1rem;
    }
    .input-container input[type="text"] {
      flex: 1;
      padding: 1rem;
      font-size: 1.1rem;
      background: #111;
      color: #f0f0f0;
      border: 1px solid #444;
      border-radius: 6px;
    }
    .input-container button {
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .input-container button:hover {
      background: #e63946;
    }
    #logout-btn {
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: auto;
      margin-bottom: 1rem;
      display: block;
    }
    #logout-btn:hover {
      color: #f0f0f0;
    }
  </style>
</head>
<body>

  <h2>Chat with "Pinky"</h2>
  <button id="logout-btn">Clear Profile & History</button>
  <div id="status">Connecting...</div>
  <div id="ollama-status">Checking Ollama status...</div>
  <div id="chat-box"></div>

  <div class="input-container">
    <input id="user-input" type="text" placeholder="Ask anything..." onkeydown="handleKey(event)" />
    <button onclick="sendMessage()">Send</button>
  </div>

<script>
  // — Profile & history storage (no visual reload) —
  function clearAll() {
    const uid = getUserId();
    localStorage.removeItem('user_id');
    localStorage.removeItem('chat_history_' + uid);
    fetch('/reset');
    window.location.reload();
  }
  document.getElementById('logout-btn').onclick = clearAll;

  function getUserId() {
    let id = localStorage.getItem('user_id');
    if (!id) {
      id = crypto.randomUUID?.() || 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r = Math.random()*16|0, v=c=='x'?r:(r&0x3|0x8);
        return v.toString(16);
      });
      localStorage.setItem('user_id', id);
    }
    return id;
  }

  function historyKey() { return 'chat_history_' + getUserId(); }
  function saveHistory(role, msg) {
    const arr = JSON.parse(localStorage.getItem(historyKey())||'[]');
    arr.push({role,msg,ts:Date.now()});
    localStorage.setItem(historyKey(), JSON.stringify(arr));
  }

  // — UI rendering —
  function addMessage(role, txt, facts) {
    const box = document.getElementById('chat-box');
    const el = document.createElement('div');
    el.className = 'message';
    el.innerHTML = `<span class="${role}">${role==='user'?'You':'Pinky'}:</span> ${txt}`;
    if (facts && Object.keys(facts).length) {
      const pre = document.createElement('pre');
      pre.style.cssText = 'background:#333;padding:.5rem;margin-top:.3rem;border-radius:4px;color:#aaa';
      pre.textContent = 'Extracted Facts: ' + JSON.stringify(facts,null,2);
      el.appendChild(pre);
    }
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
    saveHistory(role, txt);
  }

  // — Ollama health —
  async function checkOllama() {
    const st = document.getElementById('ollama-status');
    try {
      const r = await fetch('/ollama_healthcheck');
      const d = await r.json();
      st.textContent = d.status==='success' 
        ? '🟢 Ollama online!' 
        : '🔴 Ollama offline: '+d.message;
      st.style.color = d.status==='success' ? '#50fa7b' : '#ff4d4d';
    } catch {
      st.textContent = '🔴 Error checking Ollama.';
      st.style.color = '#ff4d4d';
    }
  }

  // — Chat send/receive —
  function handleKey(e){ if(e.key==='Enter'){e.preventDefault();sendMessage();} }
  async function sendMessage(){
    const input = document.getElementById('user-input');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';
    addMessage('user', msg);
    try {
      const res = await fetch('/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: getUserId(), message: msg })
      });
      const d = await res.json();
      addMessage('ai', d.response, d.lexical_facts);
    } catch {
      addMessage('ai', '⚠️ Error: backend unreachable.');
    }
  }

  // — Initialization (only new greeting, no history injection) —
  async function init() {
    document.getElementById('status').textContent = '';
    try {
      const r = await fetch(`/init?user_id=${getUserId()}`);
      const d = await r.json();
      addMessage('ai', d.message);
    } catch {
      document.getElementById('status').textContent = 'Init failed.';
    }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    await checkOllama();
    await init();
    document.getElementById('user-input').focus();
  });
</script>

</body>
</html>
